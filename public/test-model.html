
<!DOCTYPE html>
<html>
<head>
  <title>Model Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
</head>
<body>
  <h1>TensorFlow.js Model Test</h1>
  <div id="status">Loading...</div>
  <pre id="log" style="background:#f0f0f0; padding:10px; max-height:500px; overflow:auto;"></pre>
  
  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      console.log(msg);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    async function testModel() {
      try {
        log('TensorFlow.js version: ' + tf.version.tfjs);
        log('Initializing backend...');
        await tf.ready();
        log('Backend: ' + tf.getBackend());
        
        log('');
        log('=== LOADING MODEL ===');
        log('This will try to load layer by layer...');
        
        // First, let's just fetch and parse the JSON to check format
        log('Fetching model.json...');
        const response = await fetch('/tfjs_model/model.json');
        const modelJson = await response.json();
        
        log('Model JSON loaded');
        log('Format: ' + modelJson.format);
        log('Generated by: ' + modelJson.generatedBy);
        log('Keras version: ' + modelJson.convertedBy);
        
        const layers = modelJson.modelTopology.model_config.config.layers;
        log('Total layers: ' + layers.length);
        
        // Check each layer type
        const layerTypes = {};
        layers.forEach(l => {
          layerTypes[l.class_name] = (layerTypes[l.class_name] || 0) + 1;
        });
        log('Layer types: ' + JSON.stringify(layerTypes));
        
        log('');
        log('=== ATTEMPTING tf.loadLayersModel ===');
        log('Starting at: ' + new Date().toLocaleTimeString());
        statusEl.textContent = 'Loading model (browser may freeze)...';
        
        // Try to load
        const startTime = Date.now();
        const model = await tf.loadLayersModel('/tfjs_model/model.json');
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        
        log('');
        log('=== SUCCESS! ===');
        log('Model loaded in ' + elapsed + ' seconds');
        log('Input shape: ' + JSON.stringify(model.inputs[0].shape));
        log('Output shape: ' + JSON.stringify(model.outputs[0].shape));
        log('Layers in model: ' + model.layers.length);
        
        statusEl.textContent = 'Model loaded successfully!';
        statusEl.style.color = 'green';
        
        // Test prediction
        log('');
        log('=== TEST PREDICTION ===');
        const testInput = tf.zeros([1, 128, 128, 3]);
        const prediction = model.predict(testInput);
        const data = await prediction.data();
        log('Prediction shape: ' + prediction.shape);
        log('First 5 values: ' + Array.from(data.slice(0, 5)).map(v => v.toFixed(4)).join(', '));
        
        testInput.dispose();
        prediction.dispose();
        
        log('');
        log('ALL TESTS PASSED!');
        
      } catch (error) {
        log('');
        log('=== ERROR ===');
        log('Error: ' + error.message);
        log('Stack: ' + error.stack);
        statusEl.textContent = 'ERROR: ' + error.message;
        statusEl.style.color = 'red';
      }
    }
    
    // Start test after page loads
    window.onload = () => {
      log('Page loaded, starting test in 1 second...');
      setTimeout(testModel, 1000);
    };
  </script>
</body>
</html>
